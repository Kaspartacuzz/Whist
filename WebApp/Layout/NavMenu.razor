@using Core
@using WebApp.Components
@inject Service.AuthServices.IAuthService AuthService
@inject NavigationManager NavigationManager

<!-- LoginModal-komponenten -->
<LoginComponent @ref="_loginComponent" OnLoginSuccess="HandleLogin" />

<nav class="nav-root">
    <div class="nav-bar">
        <!-- Brug NavLink som før (samme route-adfærd) -->
        <NavLink class="brand" href="" @onclick="CloseMobileMenu" Match="NavLinkMatch.All">
            Whist Holdet
        </NavLink>

        <!-- Desktop links -->
        <div class="desktop-links">
            @if (_currentUser is not null)
            {
                <NavLink class="nav-btn" href="bøder" Match="NavLinkMatch.Prefix">Bøder</NavLink>
            }

            <NavLink class="nav-btn" href="highlights" Match="NavLinkMatch.Prefix">Highlights</NavLink>
            <NavLink class="nav-btn" href="medlemmer" Match="NavLinkMatch.Prefix">Medlemmer</NavLink>
            <NavLink class="nav-btn" href="regler" Match="NavLinkMatch.Prefix">Regler</NavLink>
            <NavLink class="nav-btn" href="skema" Match="NavLinkMatch.Prefix">Skema</NavLink>
            <NavLink class="nav-btn" href="kalender" Match="NavLinkMatch.Prefix">Kalender</NavLink>
        </div>

        <!-- Desktop login/logout (samme logik som før) -->
        @if (_currentUser is null)
        {
            <button type="button" class="logout-btn desktop-logout login" @onclick="ToggleLogin">
                Log ind
            </button>
        }
        else
        {
            <button type="button" class="logout-btn desktop-logout" @onclick="ToggleLogin">
                Log ud
            </button>
        }

        <!-- Mobile toggle -->
        <button type="button" class="hamburger" @onclick="ToggleMobileMenu" aria-label="Menu">
            <span class="hamburger-icon">☰</span>
        </button>
    </div>

    <!-- Mobile menu -->
    <div class="mobile-menu @(isMobileOpen ? "open" : "")">
        <div class="mobile-links">
            @if (_currentUser is not null)
            {
                <NavLink class="mobile-btn" href="bøder" Match="NavLinkMatch.Prefix" @onclick="CloseMobileMenu">
                    Bøder
                </NavLink>
            }

            <NavLink class="mobile-btn" href="highlights" Match="NavLinkMatch.Prefix" @onclick="CloseMobileMenu">
                Highlights
            </NavLink>
            <NavLink class="mobile-btn" href="medlemmer" Match="NavLinkMatch.Prefix" @onclick="CloseMobileMenu">
                Medlemmer
            </NavLink>
            <NavLink class="mobile-btn" href="regler" Match="NavLinkMatch.Prefix" @onclick="CloseMobileMenu">
                Regler
            </NavLink>
            <NavLink class="mobile-btn" href="skema" Match="NavLinkMatch.Prefix" @onclick="CloseMobileMenu">
                Skema
            </NavLink>
            <NavLink class="mobile-btn" href="kalender" Match="NavLinkMatch.Prefix" @onclick="CloseMobileMenu">
                Kalender
            </NavLink>
        </div>

        <!-- Mobile login/logout -->
        @if (_currentUser is null)
        {
            <button type="button" class="logout-btn mobile-logout login" @onclick="ToggleLogin">
                Log ind
            </button>
        }
        else
        {
            <button type="button" class="logout-btn mobile-logout" @onclick="ToggleLogin">
                Log ud
            </button>
        }
    </div>
</nav>

@code {
    private LoginComponent? _loginComponent;
    private User? _currentUser;
    private bool isMobileOpen;

    protected override async Task OnInitializedAsync()
    {
        _currentUser = await AuthService.GetCurrentUser();
    }

    private async Task HandleLogin()
    {
        _currentUser = await AuthService.GetCurrentUser();
        StateHasChanged();
    }

    private async Task ToggleLogin()
    {
        // Luk mobilmenu så UI ikke "hænger"
        isMobileOpen = false;

        if (_currentUser is null)
        {
            _loginComponent?.Show();
        }
        else
        {
            await AuthService.Logout();
            _currentUser = null;

            // som før
            NavigationManager.NavigateTo("/");
        }
    }

    private void ToggleMobileMenu() => isMobileOpen = !isMobileOpen;

    private void CloseMobileMenu()
    {
        if (isMobileOpen)
            isMobileOpen = false;
    }
}

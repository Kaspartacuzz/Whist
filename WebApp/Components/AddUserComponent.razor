@using System.ComponentModel.DataAnnotations
@using Core
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Web

@inject Service.IUserService UserService
@inject Service.UploadServices.IUploadService UploadService

@* =========================================================
   AddUserComponent
   Form√•l:
   - Viser en modal til at oprette eller redigere en bruger (User)
   - Underst√∏tter billede-upload via UploadService (api/upload/image)
   - Ved gem kaldes UserService (AddUser/Update) og parent f√•r besked via OnUserAdded
   ========================================================= *@

@* Modal vises kun n√•r showModal = true *@
@if (showModal)
{
    @* Backdrop: klik udenfor lukker modal (samme UX som dine andre modals) *@
    <div class="modal-backdrop" 
         tabindex="0"
         @onkeydown="HandleKeyDown"
         @onclick="Close">

        @* Modal container: stopPropagation g√∏r at klik i boksen ikke lukker modal *@
        <div class="modal-container" @onclick:stopPropagation="true">

            @* Titel afh√¶nger af om vi opretter eller redigerer *@
            <h3 class="modal-title">@(UserToEdit is null ? "Opret ny bruger" : "Rediger bruger")</h3>

            @* Inputfelter:
               - oninput => state opdateres mens man skriver
               - maxlength matcher dine nuv√¶rende begr√¶nsninger *@
            <input class="modal-input"
                   placeholder="Fulde navn"
                   maxlength="40"
                   @bind-value="Name"
                   @bind-value:event="oninput" />

            <input class="modal-input"
                   placeholder="Kaldenavn"
                   maxlength="30"
                   @bind-value="NickName"
                   @bind-value:event="oninput" />

            <input class="modal-input"
                   placeholder="Email"
                   maxlength="100"
                   type="email"
                   @bind-value="Email"
                   @bind-value:event="oninput" />

            <input class="modal-input"
                   placeholder="Kodeord"
                   type="password"
                   maxlength="100"
                   @bind-value="Password"
                   @bind-value:event="oninput" />

            <input class="modal-input"
                   placeholder="Adresse"
                   maxlength="200"
                   @bind-value="Address"
                   @bind-value:event="oninput" />

            <input class="modal-input"
                   placeholder="Telefonnummer"
                   maxlength="8"
                   type="tel"
                   @bind-value="PhoneNumber"
                   @bind-value:event="oninput" />

            <textarea class="modal-textarea"
                      placeholder="Beskrivelse"
                      minlength="8"
                      maxlength="500"
                      @bind-value="Description"
                      @bind-value:event="oninput"></textarea>

            <input class="modal-input"
                   placeholder="Fun fact"
                   maxlength="200"
                   @bind-value="FunFact"
                   @bind-value:event="oninput" />

            @* F√∏dselsdato:
               - Bruger InputDate for korrekt binding
               - BirthDate er DateOnly? *@
            <div class="modal-field">
                <label class="modal-label">F√∏dselsdato</label>
                <InputDate @bind-Value="BirthDate" class="modal-input" />
            </div>

            @* Billede upload:
               - Skjuler standard InputFile og bruger en ‚Äúlilla knap‚Äù label
               - N√•r der v√¶lges fil, uploader vi straks og gemmer URL som ImagePreview *@
            <label for="file-upload" class="custom-file-label">üì∑ Vedh√¶ft billede</label>
            <div class="file-input-wrapper">
                <InputFile id="file-upload" OnChange="HandleImageUpload" accept="image/*" />
            </div>

            @* Preview af uploaded/eksisterende billede *@
            @if (!string.IsNullOrEmpty(ImagePreview))
            {
                <img src="@ImagePreview" alt="Preview" class="modal-image-preview" />
            }

            @* Upload-fejl (fx for stor fil eller server-fejl) *@
            @if (!string.IsNullOrWhiteSpace(UploadErrorMessage))
            {
                <div style="color: red; font-size: 0.9rem;">@UploadErrorMessage</div>
            }

            @* Valideringsfejl (manglende felter osv.) *@
            @if (!string.IsNullOrWhiteSpace(ValidationErrorMessage))
            {
                <div style="color: red; font-size: 0.9rem;">@ValidationErrorMessage</div>
            }

            @* Actions:
               - Prim√¶r knap gemmer (CreateUser)
               - Cancel lukker uden at gemme *@
            <div class="modal-actions">
                <button @ref="ConfirmButtonRef" class="modal-btn primary" @onclick="CreateUser">
                    @(UserToEdit is null ? "Opret bruger" : "Gem √¶ndringer")
                </button>

                <button class="modal-btn cancel" @onclick="Close">Annuller</button>
            </div>

        </div>
    </div>
}

@code {
    // =========================
    // State (modal + formfelter)
    // =========================
    private bool showModal;

    private string Name = "";
    private string NickName = "";
    private string Email = "";
    private string Password = "";
    private string Address = "";
    private string PhoneNumber = "";
    private DateOnly? BirthDate = null;
    private string Description = "";
    private string FunFact = "";

    // Upload state
    private IBrowserFile? UploadedImage;
    private string? ImagePreview;               // URL fra UploadService (bruges som preview + gemmes p√• user)
    private string? UploadErrorMessage;

    // Edit state
    private User? UserToEdit;
    private string ImageUrl = "";               // eksisterende url (bruges n√•r man redigerer)

    // Validering
    private string? ValidationErrorMessage;
    
    // Fokus-h√•ndtering (s√• Enter virker direkte)
    private ElementReference ConfirmButtonRef;
    private bool _shouldFocusConfirmButton;

    // =========================
    // Callback til parent
    // =========================

    /// <summary>
    /// Parent (UserPage) kaldes n√•r bruger er oprettet/√¶ndret, s√• listen kan reloades.
    /// </summary>
    [Parameter] public EventCallback OnUserAdded { get; set; }

    // =========================
    // Public API (kald via @ref)
    // =========================

    /// <summary>
    /// √Öbner modal.
    /// - userToEdit != null => rediger eksisterende bruger
    /// - userToEdit == null => opret ny bruger
    /// </summary>
    public Task Show(User? userToEdit = null)
    {
        ValidationErrorMessage = null;
        UploadErrorMessage = null;

        UserToEdit = userToEdit;

        if (userToEdit is not null)
        {
            // Redigering: udfyld formular med eksisterende data
            Name = userToEdit.Name;
            Email = userToEdit.Email;
            NickName = userToEdit.NickName;
            Password = userToEdit.Password;
            Address = userToEdit.Address;
            PhoneNumber = userToEdit.PhoneNumber;
            BirthDate = userToEdit.BirthDate;
            Description = userToEdit.Description;
            FunFact = userToEdit.FunFact;

            // Billede: bevar eksisterende url (og brug den som preview hvis der ikke uploades nyt)
            ImageUrl = userToEdit.ImageUrl;
            ImagePreview = userToEdit.ImageUrl;
        }
        else
        {
            // Oprettelse: nulstil felter
            Name = "";
            Email = "";
            NickName = "";
            Password = "";
            Address = "";
            PhoneNumber = "";

            // OBS: beholdt din eksisterende adf√¶rd.
            // InputDate kan v√¶re f√∏lsom ift. null i nogle setups, s√• du brugte MaxValue som ‚Äúdefault‚Äù.
            BirthDate = DateOnly.FromDateTime(DateTime.Now);

            Description = "";
            FunFact = "";

            ImageUrl = "";
            ImagePreview = null;
        }

        showModal = true;
        _shouldFocusConfirmButton = true;
        
        StateHasChanged(); // vigtigt n√•r Show() kaldes udefra via @ref
        return Task.CompletedTask;
    }

    /// <summary>
    /// Lukker modal og rydder form-state.
    /// </summary>
    private void Close()
    {
        showModal = false;

        Name = NickName = Email = Password = Address = PhoneNumber = Description = FunFact = "";
        BirthDate = DateOnly.MaxValue;

        UploadedImage = null;
        ImagePreview = null;
        ImageUrl = "";

        ValidationErrorMessage = null;
        UploadErrorMessage = null;
        UserToEdit = null;
    }

    // =========================
    // Upload
    // =========================

    /// <summary>
    /// Uploader et valgt billede og gemmer den URL som backend returnerer.
    /// URL‚Äôen bruges b√•de som preview og gemmes i user.ImageUrl ved submit.
    /// </summary>
    private async Task HandleImageUpload(InputFileChangeEventArgs e)
    {
        UploadedImage = e.File;
        UploadErrorMessage = null;

        try
        {
            var resultUrl = await UploadService.UploadImageAsync(UploadedImage);

            if (!string.IsNullOrEmpty(resultUrl))
            {
                ImagePreview = resultUrl;
            }
            else
            {
                UploadErrorMessage = "Upload mislykkedes. Pr√∏v igen.";
            }
        }
        catch (Exception ex)
        {
            UploadErrorMessage = "Fejl under upload: " + ex.Message;
        }

        await InvokeAsync(StateHasChanged);
    }

    // =========================
    // Create / Update
    // =========================

    private async Task CreateUser()
    {
        ValidationErrorMessage = null;

        // -------------------------
        // Manuelle valideringer
        // -------------------------
        if (string.IsNullOrWhiteSpace(Name) || Name.Length > 40)
        {
            ValidationErrorMessage = "Navn er p√•kr√¶vet (maks 40 tegn).";
            return;
        }

        if (string.IsNullOrWhiteSpace(NickName))
        {
            ValidationErrorMessage = "Kaldenavn er p√•kr√¶vet.";
            return;
        }

        if (string.IsNullOrWhiteSpace(Email) || !new EmailAddressAttribute().IsValid(Email))
        {
            ValidationErrorMessage = "Ugyldig eller tom emailadresse.";
            return;
        }

        if (string.IsNullOrWhiteSpace(Password) || Password.Length < 6)
        {
            ValidationErrorMessage = "Kodeord er p√•kr√¶vet og skal v√¶re mindst 6 tegn.";
            return;
        }

        if (string.IsNullOrWhiteSpace(Address))
        {
            ValidationErrorMessage = "Adresse skal udfyldes.";
            return;
        }

        if (string.IsNullOrWhiteSpace(PhoneNumber))
        {
            ValidationErrorMessage = "Telefonnummer skal udfyldes.";
            return;
        }

        if (!new PhoneAttribute().IsValid(PhoneNumber) || PhoneNumber.Length != 8)
        {
            ValidationErrorMessage = "Ugyldigt telefonnummer (skal v√¶re 8 cifre).";
            return;
        }

        // -------------------------
        // Gem (update eller create)
        // -------------------------
        if (UserToEdit is not null)
        {
            // Rediger eksisterende bruger
            UserToEdit.Name = Name;
            UserToEdit.NickName = NickName;
            UserToEdit.Email = Email;
            UserToEdit.Password = Password;
            UserToEdit.Address = Address;
            UserToEdit.PhoneNumber = PhoneNumber;
            UserToEdit.BirthDate = BirthDate;
            UserToEdit.Description = Description;
            UserToEdit.FunFact = FunFact;

            // Hvis der er uploadet et nyt billede, bruger vi det.
            // Ellers bevarer vi det eksisterende.
            UserToEdit.ImageUrl = ImagePreview ?? UserToEdit.ImageUrl;

            await UserService.Update(UserToEdit);
        }
        else
        {
            // Opret ny bruger
            var newUser = new User
            {
                Name = Name,
                NickName = NickName,
                Email = Email,
                Password = Password,
                Address = Address,
                PhoneNumber = PhoneNumber,
                BirthDate = BirthDate,
                Description = Description,
                FunFact = FunFact,
                ImageUrl = ImagePreview ?? ""
            };

            await UserService.AddUser(newUser);
        }

        // Fort√¶l parent at listen skal reloades
        await OnUserAdded.InvokeAsync();

        Close();
    }
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        // N√•r modalen √•bner, fokus√©r "Ja"-knappen √©n gang
        if (_shouldFocusConfirmButton)
        {
            _shouldFocusConfirmButton = false;
            try { await ConfirmButtonRef.FocusAsync(); } catch { }
        }
    }

    // Keyboard handling
    // =========================

    /// <summary>
    /// Enter => Confirm
    /// Escape => Cancel
    /// </summary>
    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        // Enter => gem/bekr√¶ft
        if (e.Key == "Enter")
            await OnEnter();

        // Escape => annuller/luk
        else if (e.Key == "Escape")
            await OnEscape();
    }
    
    // =========================
    // Actions
    // =========================
    private Task OnEnter() => CreateUser();
    private Task OnEscape() { Close(); return Task.CompletedTask; }
}

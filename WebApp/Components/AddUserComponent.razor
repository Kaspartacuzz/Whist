@using Core
@using Microsoft.AspNetCore.Components.Forms
@inject Service.IUserService UserService

@if (showModal)
{
    <div class="modal-backdrop">
        <div class="modal-container">
            <h3 class="modal-title">@(UserToEdit is null ? "Opret ny bruger" : "Rediger bruger")</h3>

            <input @bind="Name" placeholder="Fulde navn" class="modal-input" />
            <input @bind="NickName" placeholder="Kaldenavn" class="modal-input" />
            <input @bind="Email" placeholder="Email" class="modal-input" />
            <input @bind="Password" placeholder="Kodeord" type="password" class="modal-input" />
            <input @bind="PhoneNumber" placeholder="Telefonnummer" class="modal-input" />
            <textarea @bind="Description" placeholder="Beskrivelse" class="modal-textarea"></textarea>
            <input @bind="FunFact" placeholder="Fun fact" class="modal-input" />

            <label for="file-upload" class="custom-file-label">üì∑ Vedh√¶ft billede</label>
            <div class="file-input-wrapper">
                <InputFile id="file-upload" OnChange="HandleImageUpload" accept="image/*" />
            </div>

            @if (!string.IsNullOrEmpty(ImagePreview))
            {
                <img src="@ImagePreview" alt="Preview" class="modal-image-preview" />
            }

            <div class="modal-actions">
                <button class="modal-btn primary" @onclick="CreateUser">
                    @(UserToEdit is null ? "Opret bruger" : "Gem √¶ndringer")
                </button>
                <button class="modal-btn cancel" @onclick="Close">Annuller</button>
            </div>
        </div>
    </div>
}

@code {
    private bool showModal = false;
    private string Name = "";
    private string NickName = "";
    private string Email = "";
    private string Password = "";
    private string PhoneNumber = "";
    private string Description = "";
    private string FunFact = "";
    private IBrowserFile? UploadedImage;
    private string? ImagePreview;
    private User? UserToEdit = null;
    private string ImageUrl = "";
    private string? UploadErrorMessage = null;

    [Parameter] public EventCallback OnUserAdded { get; set; }

    public Task Show(User? userToEdit = null)
    {
        UserToEdit = userToEdit;

        if (userToEdit is not null)
        {
            // Udfyld formular med eksisterende brugerdata
            Name = userToEdit.Name;
            Email = userToEdit.Email;
            NickName = userToEdit.NickName;
            Password = userToEdit.Password;
            PhoneNumber = userToEdit.PhoneNumber;
            Description = userToEdit.Description;
            FunFact = userToEdit.FunFact;
            ImageUrl = userToEdit.ImageUrl;
        }
        else
        {
            // Nulstil felter
            Name = "";
            Email = "";
            NickName = "";
            Password = "";
            PhoneNumber = "";
            Description = "";
            FunFact = "";
            ImageUrl = "";
        }

        showModal = true;
        StateHasChanged();
        return Task.CompletedTask;
    }

    private void Close()
    {
        showModal = false;
        Name = NickName = Email = Password = PhoneNumber = Description = FunFact = "";
        UploadedImage = null;
        ImagePreview = null;
    }

    private async Task HandleImageUpload(InputFileChangeEventArgs e)
    {
        UploadedImage = e.File;
        var buffer = new byte[UploadedImage.Size];
        try
        {
            using var stream = UploadedImage.OpenReadStream(maxAllowedSize: 10_000_000); // 10 MB
            await stream.ReadAsync(buffer);
            ImagePreview = $"data:{UploadedImage.ContentType};base64,{Convert.ToBase64String(buffer)}";
        }
        catch (Exception ex)
        {
            ImagePreview = null;
            UploadErrorMessage = "Billedet kunne ikke l√¶ses. Pr√∏v et andet format eller en mindre fil.";
            Console.WriteLine("Fejl ved billedupload: " + ex.Message);
        }

        ImagePreview = $"data:{UploadedImage.ContentType};base64,{Convert.ToBase64String(buffer)}";
    }
    
    private async Task CreateUser()
    {
        if (UserToEdit is not null)
        {
            // Rediger eksisterende bruger
            UserToEdit.Name = Name;
            UserToEdit.NickName = NickName;
            UserToEdit.Email = Email;
            UserToEdit.Password = Password;
            UserToEdit.PhoneNumber = PhoneNumber;
            UserToEdit.Description = Description;
            UserToEdit.FunFact = FunFact;
            UserToEdit.ImageUrl = ImagePreview ?? UserToEdit.ImageUrl;

            await UserService.Update(UserToEdit);
        }
        else
        {
            // Opret ny bruger
            var newUser = new User
            {
                Name = Name,
                NickName = NickName,
                Email = Email,
                Password = Password,
                PhoneNumber = PhoneNumber,
                Description = Description,
                FunFact = FunFact,
                ImageUrl = ImagePreview ?? ""
            };

            await UserService.AddUser(newUser);
        }

        await OnUserAdded.InvokeAsync();
        Close();
    }
}
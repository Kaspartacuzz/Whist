@using Core
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Web

@inject Service.HighlightServices.IHighlightService HighlightService
@inject Service.AuthServices.IAuthService AuthService
@inject Service.UploadServices.IUploadService UploadService

@if (showModal)
{
    <div class="modal-backdrop" 
         tabindex="0"
         @onkeydown="HandleKeyDown"
         @onclick="Close">
        @* Stop klik inde i modal fra at lukke den *@
        <div class="modal-container" @onclick:stopPropagation="true">
            <h3 class="modal-title">
                @(HighlightToEdit is null ? "Opret nyt highlight" : "Rediger highlight")
            </h3>

            @* oninput giver live-opdatering mens man skriver *@
            <input class="modal-input"
                   placeholder="Titel"
                   maxlength="80"
                   @bind-value="Title"
                   @bind-value:event="oninput" />

            <textarea class="modal-textarea"
                      placeholder="Beskrivelse"
                      maxlength="400"
                      @bind-value="Description"
                      @bind-value:event="oninput"></textarea>

            @* Upload billede (gemmer fil i wwwroot/uploads via UploadController og f√•r en URL retur) *@
            <label for="file-upload" class="custom-file-label">üì∑ Vedh√¶ft billede</label>
            <div class="file-input-wrapper">
                <InputFile id="file-upload" OnChange="HandleImageUpload" accept="image/*" />
            </div>

            @* Preview viser URL'en (enten eksisterende billede eller nyligt uploadet) *@
            @if (!string.IsNullOrWhiteSpace(ImagePreview))
            {
                <img src="@ImagePreview" alt="Preview" class="modal-image-preview" />
            }

            <label class="modal-checkbox">
                <input type="checkbox" @bind="IsPrivate" />
                G√∏r privat (kun synlig for medlemmer)
            </label>

            @* Upload fejl (fx for stor fil eller server-fejl) *@
            @if (!string.IsNullOrWhiteSpace(UploadErrorMessage))
            {
                <div style="color: red; font-size: 0.9rem;">@UploadErrorMessage</div>
            }

            @* Valideringsfejl (titel/beskrivelse mangler) *@
            @if (!string.IsNullOrWhiteSpace(ValidationErrorMessage))
            {
                <div style="color: red; font-size: 0.9rem;">@ValidationErrorMessage</div>
            }

            <div class="modal-actions">
                <button @ref="ConfirmButtonRef" class="modal-btn primary" @onclick="SaveHighlightAsync">
                    @(HighlightToEdit is null ? "Opret highlight" : "Gem √¶ndringer")
                </button>
                <button class="modal-btn cancel" @onclick="Close">Annuller</button>
            </div>
        </div>
    </div>
}

@code {
    // =========================
    // Modal state + formfelter
    // =========================
    private bool showModal;

    private string Title = "";
    private string Description = "";

    private bool IsPrivate;

    // Upload state
    private IBrowserFile? UploadedImage;
    private string? ImagePreview;               // URL til billede (fra UploadService)
    private string? UploadErrorMessage;
    
    // Fokus-h√•ndtering (s√• Enter virker direkte)
    private ElementReference ConfirmButtonRef;
    private bool _shouldFocusConfirmButton;

    // Validering
    private string? ValidationErrorMessage;

    // =========================
    // Params / callbacks
    // =========================

    /// <summary>
    /// Kald fra parent, n√•r highlight er oprettet/√¶ndret, s√• listen kan reloades.
    /// </summary>
    [Parameter] public EventCallback OnHighlightAdded { get; set; }

    /// <summary>
    /// Hvis sat: modal er i "edit mode".
    /// Hvis null: modal er i "create mode".
    /// </summary>
    [Parameter] public Highlight? HighlightToEdit { get; set; }

    // =========================
    // Public API (kaldes via @ref fra parent)
    // =========================

    /// <summary>
    /// √Öbner modal og udfylder felter hvis det er redigering.
    /// </summary>
    public void Show(Highlight? highlight = null)
    {
        HighlightToEdit = highlight;

        // Nulstil fejlbeskeder
        UploadErrorMessage = null;
        ValidationErrorMessage = null;

        if (HighlightToEdit is not null)
        {
            // Redigering: udfyld eksisterende data
            Title = HighlightToEdit.Title;
            Description = HighlightToEdit.Description;
            ImagePreview = HighlightToEdit.ImageUrl;

            // Vigtigt: bevar privacy-state ved redigering
            IsPrivate = HighlightToEdit.IsPrivate;
        }
        else
        {
            // Opret: reset felter
            Title = "";
            Description = "";
            UploadedImage = null;
            ImagePreview = null;
            IsPrivate = false;
        }

        showModal = true;
        _shouldFocusConfirmButton = true;
        
        StateHasChanged();
    }

    /// <summary>
    /// Lukker modal og rydder felter.
    /// </summary>
    private void Close()
    {
        showModal = false;

        Title = "";
        Description = "";
        UploadedImage = null;
        ImagePreview = null;
        IsPrivate = false;

        UploadErrorMessage = null;
        ValidationErrorMessage = null;
    }

    // =========================
    // Upload
    // =========================

    /// <summary>
    /// Uploader billedet og f√•r en offentlig URL retur (som vi gemmer i ImagePreview).
    /// </summary>
    private async Task HandleImageUpload(InputFileChangeEventArgs e)
    {
        UploadedImage = e.File;
        UploadErrorMessage = null;

        try
        {
            var resultUrl = await UploadService.UploadImageAsync(UploadedImage);

            if (!string.IsNullOrWhiteSpace(resultUrl))
            {
                ImagePreview = resultUrl;
            }
            else
            {
                UploadErrorMessage = "Upload mislykkedes. Pr√∏v igen.";
            }
        }
        catch (Exception ex)
        {
            UploadErrorMessage = "Fejl under upload: " + ex.Message;
        }

        await InvokeAsync(StateHasChanged);
    }

    // =========================
    // Save (create/update)
    // =========================

    private async Task SaveHighlightAsync()
    {
        ValidationErrorMessage = null;

        // Auth: komponenten forventer at man er logget ind.
        var user = await AuthService.GetCurrentUser();
        if (user is null)
        {
            ValidationErrorMessage = "Du skal v√¶re logget ind for at oprette highlights.";
            return;
        }

        // Manuelle tjek (UI har ogs√• maxlength, men vi validerer alligevel)
        if (string.IsNullOrWhiteSpace(Title) || Title.Length > 80)
        {
            ValidationErrorMessage = "Titel er p√•kr√¶vet (maks 80 tegn).";
            return;
        }

        if (string.IsNullOrWhiteSpace(Description) || Description.Length > 400)
        {
            ValidationErrorMessage = "Beskrivelse er p√•kr√¶vet (maks 400 tegn).";
            return;
        }

        if (HighlightToEdit is not null)
        {
            // Redig√©r eksisterende highlight
            HighlightToEdit.Title = Title;
            HighlightToEdit.Description = Description;
            HighlightToEdit.IsPrivate = IsPrivate;

            // Kun opdat√©r ImageUrl hvis vi faktisk har en URL (enten eksisterende eller ny upload)
            if (!string.IsNullOrWhiteSpace(ImagePreview))
                HighlightToEdit.ImageUrl = ImagePreview;

            await HighlightService.Update(HighlightToEdit);
        }
        else
        {
            // Opret nyt highlight
            var newHighlight = new Highlight
            {
                Title = Title,
                Description = Description,
                UserId = user.Id,
                ImageUrl = ImagePreview,     // m√• gerne v√¶re null
                Date = DateTime.UtcNow,      // backend s√¶tter ogs√• Date i repo (bevarer adf√¶rd)
                IsPrivate = IsPrivate
            };

            await HighlightService.Add(newHighlight);
        }

        // Giv parent besked om at der er sket √¶ndringer (reload liste)
        await OnHighlightAdded.InvokeAsync();

        Close();
    }
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        // N√•r modalen √•bner, fokus√©r "Ja"-knappen √©n gang
        if (_shouldFocusConfirmButton)
        {
            _shouldFocusConfirmButton = false;
            try { await ConfirmButtonRef.FocusAsync(); } catch { }
        }
    }

    // Keyboard handling
    // =========================

    /// <summary>
    /// Enter => Confirm
    /// Escape => Cancel
    /// </summary>
    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        // Enter => gem/bekr√¶ft
        if (e.Key == "Enter")
            await OnEnter();

        // Escape => annuller/luk
        else if (e.Key == "Escape")
            await OnEscape();
    }
    
    // =========================
    // Actions
    // =========================
    private Task OnEnter() => SaveHighlightAsync();
    private Task OnEscape() { Close(); return Task.CompletedTask; }
}

@using WebApp.Service.AuthServices
@inject IAuthService AuthService
@inject NavigationManager Navigation

@using Microsoft.AspNetCore.Components.Web

@* Vises kun når "show" er true *@
@if (show)
{
    <div class="modal-overlay" 
         @onclick="OnBackdropClick"
         tabindex="0"
         @onkeydown="HandleKeyDown"
         @onclick="Hide">
        @* Stop klik i selve boksen fra at lukke modal *@
        <div class="modal-box" @onclick:stopPropagation="true">
            <h3>Log ind</h3>

            @* oninput = opdaterer state mens man skriver *@
            <input type="email"
                   placeholder="Email"
                   @bind-value="email"
                   @bind-value:event="oninput" />

            <input type="password"
                   placeholder="Adgangskode"
                   @bind-value="password"
                   @bind-value:event="oninput" />

            <div class="modal-actions">
                <button @ref="ConfirmButtonRef" class="primary" @onclick="Login">Log ind</button>
                <button class="secondary" @onclick="Hide">Annuller</button>
            </div>

            @if (!string.IsNullOrWhiteSpace(errorMessage))
            {
                <p class="error-message">@errorMessage</p>
            }
        </div>
    </div>
}

@code {
    // UI-state
    private bool show;
    private string email = "";
    private string password = "";
    private string errorMessage = "";

    // Parent kan hooke på "login success" (typisk til at opdatere NavMenu state)
    [Parameter] public EventCallback OnLoginSuccess { get; set; }
    
    // Fokus-håndtering (så Enter virker direkte)
    private ElementReference ConfirmButtonRef;
    private bool _shouldFocusConfirmButton;

    /// <summary>
    /// Vises udefra (fx via @ref i NavMenu).
    /// </summary>
    public void Show()
    {
        show = true;
        errorMessage = "";
        StateHasChanged(); // vigtigt når kaldet kommer udefra
    }

    /// <summary>
    /// Lukker modal og nulstiller felter.
    /// </summary>
    public void Hide()
    {
        show = false;
        email = "";
        password = "";
        errorMessage = "";
        StateHasChanged(); // sikrer at UI opdaterer med det samme når man lukker
    }

    private void OnBackdropClick()
    {
        // Klik udenfor boksen lukker modal (valgfrit, men lækkert UX)
        Hide();
    }

    private async Task Login()
    {
        errorMessage = "";

        var success = await AuthService.Login(email, password);

        if (success)
        {
            // Navigér + giv besked til parent om at login lykkedes
            Navigation.NavigateTo("/");
            await OnLoginSuccess.InvokeAsync();
            Hide();
            return;
        }

        errorMessage = "Forkert email eller adgangskode";
        StateHasChanged(); // sørg for fejltekst kommer frem med det samme
    }
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        // Når modalen åbner, fokusér "Ja"-knappen én gang
        if (_shouldFocusConfirmButton)
        {
            _shouldFocusConfirmButton = false;
            try { await ConfirmButtonRef.FocusAsync(); } catch { }
        }
    }

    // Keyboard handling
    // =========================

    /// <summary>
    /// Enter => Confirm
    /// Escape => Cancel
    /// </summary>
    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        // Enter => gem/bekræft
        if (e.Key == "Enter")
            await OnEnter();

        // Escape => annuller/luk
        else if (e.Key == "Escape")
            await OnEscape();
    }
    
    // =========================
    // Actions
    // =========================
    private Task OnEnter() => Login();
    private Task OnEscape() { Hide(); return Task.CompletedTask; }

}

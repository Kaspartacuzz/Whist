@page "/users"

@using Core
@using WebApp.Components
@using WebApp.Service
@using WebApp.Service.FineServices
@inject IUserService UserService
@inject IFineService FineService

<h2>Medlemmer</h2>

<!-- Knappen til at åbne opret-bruger-modal -->
<button @onclick="OpenAddUserModal">Tilføj bruger</button>
<AddUserComponent @ref="addUserComponent" OnUserAdded="ReloadUsers" />

<!-- Bokse med info om alle brugere -->
<div class="user-boxes">
    @foreach (var user in Users)
    {
        var totalFines = user.Fines?.Sum(f => f.Amount) ?? 0;

        <div class="user-box" style="border: 1px solid gray; padding: 15px; margin-bottom: 10px;">
            <h3>@user.NickName</h3>

            @if (!string.IsNullOrEmpty(user.ImageUrl))
            {
                <img src="@user.ImageUrl" alt="Billede af @user.NickName" width="150" />
            }

            <p><strong>Fulde navn:</strong> @user.Name</p>
            <p><strong>Beskrivelse:</strong> @user.Description</p>
            <p><strong>Fun fact:</strong> @user.FunFact</p>
            <p><strong>Samlet antal bøder:</strong> @totalFines kr</p>
        </div>
    }
</div>

@code {
    private List<User> Users = new();
    private AddUserComponent? addUserComponent;

    protected override async Task OnInitializedAsync()
    {
        await LoadUsers();
    }

    private async Task LoadUsers()
    {
        Users = (await UserService.GetAll()).ToList();
    }

    private async Task ReloadUsers()
    {
        await LoadUsers();
        StateHasChanged();
    }

    private void OpenAddUserModal()
    {
        addUserComponent?.Show();
    }
}

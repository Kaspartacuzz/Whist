@page "/skema"
@using Core
@using WebApp.Components
@using WebApp.Service
@using WebApp.Service.FineServices
@using WebApp.Service.PointServices
@inject IPointService PointService
@inject IUserService UserService
@inject IFineService FineService
@inject IJSRuntime JS
@inject Service.AuthServices.IAuthService AuthService

@* ------------------------------------------------------------
   Side: Whist Point Skema
   - Viser pointskemaet som “grid”
   - Viser sol-meldinger + pointoversigt (inkl. stjerner)
   - Modal åbnes ved klik på en gyldig point-celle
   ------------------------------------------------------------ *@

<h3 class="whist-point-title">Whist Point Skema</h3>

@* Hovedskema: rækker = meldinger/labels, kolonner = niveauer (Columns) *@
<div class="table-scroll">
    <table class="point-table">
        <thead>
        <tr>
            @* Venstre header til selve rækkernes label *@
            <th>Melding</th>

            @* Dynamiske kolonne-headere (styling afhænger af GetHeaderClass) *@
            @for (var i = 0; i < Columns.Count; i++)
            {
                <th class="@GetHeaderClass(i)">@Columns[i]</th>
            }
        </tr>
        </thead>

        <tbody>
        @* Alle rækker i grid’et *@
        @foreach (var row in GridRows)
        {
            <tr>
                @* Rækkelabel (blå celle) med intensitet, så man visuelt kan skelne grupper *@
                <th class="cell-blue @GetIntensityFromLabel(row.Label)">
                    @row.Label
                </th>

                @* Point-cellerne i rækken *@
                @for (var i = 0; i < row.Points.Count; i++)
                {
                    @* value kan være null (ingen celle/ikke relevant), eller et tal *@
                    var value = row.Points[i];

                    @* Klik åbner modal via OnPointClick (typisk først relevant når bruger er logget ind) *@
                    <td class="@GetCellClass(value, i, row.Label) @(_currentUser is null ? "disabled" : "")"
                        @onclick="() => OnPointClick(value)">
                        @* Vis kun positive point-tal (ellers vises tom streng) *@
                        @((value.HasValue && value.Value > 0) ? value.Value.ToString() : "")
                    </td>
                }
            </tr>
        }
        </tbody>
    </table>
</div>

@* ------------------------------------------------------------
   Sektion under tabellen:
   - Venstre: Sol-meldinger (egen komponent)
   - Højre: Pointoversigt (summering pr. spiller + stjerner)
   ------------------------------------------------------------ *@
<div class="below-tables-container">
    @* Sol-meldinger (separate komponent) *@
    <div class="sun-scheme">
        <div class="top-bar">
            <h4>Sol-meldinger</h4>
        </div>

        @* Når sol-point ændres, genindlæses pointdata via LoadPoints *@
        <SunSchemeComponent PointsChanged="LoadPoints" CanInteract="@(_currentUser is not null)"/>
    </div>

    @* Pointoversigt pr. spiller *@
    <div class="point-summary">
        <div class="top-bar">
            <h4>Pointoversigt</h4>

            @* Kun logget-in bruger kan “tilføje bøder” ud fra point *@
            @if (_currentUser is not null)
            {
                <button class="btn-add" @onclick="ResetPointsAndCreateFines">+ Tilføj bøder</button>
            }
        </div>

        <table class="point-overview-table">
            <thead>
            <tr>
                <th>Spiller</th>
                <th>Point</th>
            </tr>
            </thead>

            <tbody>
            @* Bygger en “view-model” til tabellen:
               - Name fra PlayerNames
               - Total fra PlayerTotals (fallback = 0)
               - Sortér: flest point først, derefter navn *@
            @foreach (var row in PlayerNames
                          .Select(kvp => new
                          {
                              Id = kvp.Key,
                              Name = kvp.Value,
                              Total = (PlayerTotals != null && PlayerTotals.TryGetValue(kvp.Key, out var t)) ? t : 0
                          })
                          .OrderByDescending(x => x.Total)   // behold “flest point først”
                          .ThenBy(x => x.Name))              // pæn stabil sortering
            {
                @* CSS-klasse til farvekodning af positive/negative totals *@
                var cssClass = row.Total > 0 ? "positive" : row.Total < 0 ? "negative" : "";

                <tr>
                    <td>@row.Name</td>

                    <td class="@cssClass point-cell">
                        @* Selve totalsummen *@
                        <span class="point-value">@row.Total</span>

                        @* Stjerneknap pr. spiller (session-stjerner) *@
                        <div class="star-button-wrapper star-in-table">
                            @* Klik giver en stjerne til spilleren i den aktuelle session *@
                            <button class="star-button @(_currentUser is null ? "disabled" : "")"
                                    type="button"
                                    @onclick="() => AddSessionStar(row.Id)">
                                ⭐
                                @* Vis antal stjerner kun når der er mindst 1 *@
                                @if (GetSessionStars(row.Id) > 0)
                                {
                                    <span class="star-count">@GetSessionStars(row.Id)</span>
                                }
                            </button>
                        </div>
                    </td>
                </tr>
            }
            </tbody>
        </table>
    </div>
</div>

@* ------------------------------------------------------------
   Modal: vælg spillere når man klikker på et point i skemaet
   - IsModalOpen styrer om den vises
   - OnConfirm / OnCancel håndteres i code-behind
   ------------------------------------------------------------ *@
@if (IsModalOpen)
{
    <SelectPlayersComponent
        PointValue="@SelectedPoint"
        Players="@Players"
        OnConfirm="HandlePointSubmission"
        OnCancel="() => IsModalOpen = false" />
}

@code {
    // ------------------------------------------------------------
    // State / data
    // ------------------------------------------------------------

    private User? _currentUser;

    private List<PointEntry> AllPoints = new();

    // PlayerId → Total
    private Dictionary<int, int> PlayerTotals = new();

    // PlayerId → NickName
    private Dictionary<int, string> PlayerNames = new();

    // Session-stjerner (kun i browseren / localStorage)
    private const string SessionStarsStorageKey = "whist.sessionStars.v1";
    private Dictionary<int, int> SessionStars = new();

    // Modal state
    private bool IsModalOpen;
    private int SelectedPoint;
    private List<SelectPlayersComponent.SelectableUser> Players = new();

    // ------------------------------------------------------------
    // Lifecycle
    // ------------------------------------------------------------

    protected override async Task OnInitializedAsync()
    {
        _currentUser = await AuthService.GetCurrentUser();

        await LoadSessionStarsAsync();
        await LoadPoints();

        // Sørg for at alle players findes som keys (så UI altid kan vise 0 stjerner)
        foreach (var id in PlayerNames.Keys)
            SessionStars.TryAdd(id, 0);

        await SaveSessionStarsAsync();
    }

    // ------------------------------------------------------------
    // Data-loading
    // ------------------------------------------------------------

    private async Task LoadPoints()
    {
        // Hent points
        AllPoints = await PointService.GetAll();

        // Hent users (til navne i oversigten)
        var users = await UserService.GetAll();
        PlayerNames = users.ToDictionary(u => u.Id, u => u.NickName);

        // Beregn total pr. spiller
        PlayerTotals = AllPoints
            .GroupBy(p => p.PlayerId)
            .ToDictionary(g => g.Key, g => g.Sum(p => p.Points));

        // Sørg for at SessionStars har keys for alle players
        foreach (var id in PlayerNames.Keys)
        {
            if (!SessionStars.ContainsKey(id))
                SessionStars[id] = 0;
        }
    }

    // ------------------------------------------------------------
    // UI: grid definition
    // ------------------------------------------------------------

    public class GridRow
    {
        public string Label { get; set; } = "";
        public List<int?> Points { get; set; } = new();
    }

    private List<string> Columns = new()
    {
        "-13", "-12", "-11", "-10", "-9", "-8", "-7", "-6", "-5", "-4", "-3", "-2", "-1", "0", "1", "2", "3", "4", "5", "6"
    };

    // Selve point-skemaet (hardcoded)
    private List<GridRow> GridRows = new()
    {
        new() { Label = "7 Alm.",  Points = new() { null, null, null, null, null, null, 4, 4, 3, 3, 2, 2, 1, 1, 1, 2, 2, 3, 3, 4 } },
        new() { Label = "7 Vip",  Points = new() { null, null, null, null, null, null, 5, 5, 4, 3, 3, 2, 1, 1, 1, 2, 3, 3, 4, 4 } },
        new() { Label = "7 Gode", Points = new() { null, null, null, null, null, null, 6, 5, 5, 4, 3, 2, 2, 1, 2, 2, 3, 4, 4, 5 } },
        new() { Label = "7 Halve",Points = new() { null, null, null, null, null, null, 8, 7, 6, 5, 4, 3, 2, 1, 2, 3, 4, 5, 6, 7 } },

        new() { Label = "8 Alm.",  Points = new() { null, null, null, null, null, 9, 8, 7, 6, 5, 4, 3, 2, 1, 2, 3, 4, 5, 6, null } },
        new() { Label = "8 Vip",  Points = new() { null, null, null, null, null, 11, 10, 9, 8, 6, 5, 4, 3, 1, 3, 4, 5, 6, 8, null } },
        new() { Label = "8 Gode", Points = new() { null, null, null, null, null, 14, 12, 11, 9, 8, 6, 5, 3, 2, 3, 5, 6, 8, 9, null } },
        new() { Label = "8 Halve",Points = new() { null, null, null, null, null, 16, 14, 12, 11, 9, 7, 5, 4, 2, 4, 5, 7, 9, 11, null } },

        new() { Label = "9 Alm.",  Points = new() { null, null, null, null, 20, 18, 16, 14, 12, 10, 8, 6, 4, 2, 4, 6, 8, 10, null, null } },
        new() { Label = "9 Vip",  Points = new() { null, null, null, null, 25, 23, 20, 18, 15, 13, 10, 8, 5, 3, 5, 8, 10, 13, null, null } },
        new() { Label = "9 Gode", Points = new() { null, null, null, null, 30, 27, 24, 21, 18, 15, 12, 9, 6, 3, 6, 9, 12, 15, null, null } },
        new() { Label = "9 Halve",Points = new() { null, null, null, null, 35, 32, 28, 25, 21, 18, 14, 11, 7, 4, 7, 11, 14, 18, null, null } },

        new() { Label = "10 Alm.",  Points = new() { null, null, null, 44, 40, 36, 32, 28, 24, 20, 16, 12, 8, 4, 8, 12, 16, null, null, null } },
        new() { Label = "10 Vip",  Points = new() { null, null, null, 55, 50, 45, 40, 35, 30, 25, 20, 15, 10, 5, 10, 15, 120, null, null, null } },
        new() { Label = "10 Gode", Points = new() { null, null, null, 66, 60, 54, 48, 42, 36, 30, 24, 18, 12, 6, 12, 18, 24, null, null, null } },
        new() { Label = "10 Halve",Points = new() { null, null, null, 77, 70, 63, 56, 49, 42, 35, 28, 21, 14, 7, 14, 21, 28, null, null, null } },

        new() { Label = "11 Alm.",  Points = new() { null, null, 96, 88, 80, 72, 64, 56, 48, 40, 32, 24, 16, 8, 16, 28, null, null, null, null } },
        new() { Label = "11 Vip",  Points = new() { null, null, 120, 110, 100, 90, 80, 70, 60, 50, 40, 30, 20, 10, 20, 30, null, null, null, null } },
        new() { Label = "11 Gode", Points = new() { null, null, 144, 132, 120, 108, 96, 84, 72, 60, 48, 36, 24, 12, 24, 36, null, null, null, null } },
        new() { Label = "11 Halve",Points = new() { null, null, 168, 154, 140, 126, 112, 98, 84, 70, 56, 42, 28, 14, 28, 42, null, null, null, null } },

        new() { Label = "12 Alm.",  Points = new() { null, 208, 192, 176, 160, 144, 128, 112, 96, 80, 64, 48, 32, 16, 32, null, null, null, null, null } },
        new() { Label = "12 Vip",  Points = new() { null, 260, 240, 220, 200, 180, 160, 140, 120, 100, 80, 60, 40, 20, 40, null, null, null, null, null } },
        new() { Label = "12 Gode", Points = new() { null, 312, 288, 264, 240, 216, 192, 168, 144, 120, 96, 72, 48, 24, 48, null, null, null, null, null } },
        new() { Label = "12 Halve",Points = new() { null, 364, 336, 308, 280, 252, 224, 196, 168, 140, 112, 84, 56, 28, 56, null, null, null, null, null } },

        new() { Label = "13 Alm.",  Points = new() { 448, 448, 416, 384, 352, 320, 288, 256, 224, 192, 160, 128, 96, 64, null, null, null, null, null, null } },
        new() { Label = "13 Vip",  Points = new() { 560, 560, 520, 480, 440, 400, 360, 320, 280, 240, 200, 160, 120, 80, null, null, null, null, null, null } },
        new() { Label = "13 Gode", Points = new() { 672, 672, 624, 576, 528, 480, 432, 384, 336, 288, 240, 192, 144, 96, null, null, null, null, null, null } },
        new() { Label = "13 Halve",Points = new() { 784, 784, 728, 672, 616, 560, 504, 448, 392, 336, 280, 224, 168, 112, null, null, null, null, null, null } },
    };

    // ------------------------------------------------------------
    // UI events
    // ------------------------------------------------------------

    private async Task OnPointClick(int? value)
    {
        if (_currentUser is null)
            return;

        if (!value.HasValue)
            return;

        SelectedPoint = value.Value;

        // Hent spillere til modal (vælg vindere/tabere)
        var users = await UserService.GetAll();
        Players = users
            .Select(u => new SelectPlayersComponent.SelectableUser { Id = u.Id, Nickname = u.NickName })
            .ToList();

        IsModalOpen = true;
    }

    /// <summary>
    /// Gemmer point ud fra vindere/tabere.
    /// - Default: 2v2
    /// - Selfmakker: 1v3 eller 3v1 → den alene får 3×
    /// </summary>
    private async Task HandlePointSubmission((List<SelectPlayersComponent.SelectableUser> winners, List<SelectPlayersComponent.SelectableUser> losers) result)
    {
        var (winners, losers) = result;
        var date = DateTime.UtcNow;

        // Selfmakker cases først (1v3 eller 3v1). 2v2 falder igennem til default.
        if (winners.Count == 1 && losers.Count == 3)
        {
            // Selfmakker er den eneste vinder (+3×)
            var self = winners[0];

            await PointService.Add(new PointEntry
            {
                PlayerId = self.Id,
                Points = SelectedPoint * 3,
                Date = date
            });

            foreach (var loser in losers)
            {
                await PointService.Add(new PointEntry
                {
                    PlayerId = loser.Id,
                    Points = -SelectedPoint,
                    Date = date
                });
            }
        }
        else if (winners.Count == 3 && losers.Count == 1)
        {
            // Selfmakker er den eneste taber (-3×)
            var self = losers[0];

            await PointService.Add(new PointEntry
            {
                PlayerId = self.Id,
                Points = -SelectedPoint * 3,
                Date = date
            });

            foreach (var winner in winners)
            {
                await PointService.Add(new PointEntry
                {
                    PlayerId = winner.Id,
                    Points = SelectedPoint,
                    Date = date
                });
            }
        }
        else
        {
            // Default 2v2 (uændret)
            foreach (var winner in winners)
            {
                await PointService.Add(new PointEntry
                {
                    PlayerId = winner.Id,
                    Points = SelectedPoint,
                    Date = date
                });
            }

            foreach (var loser in losers)
            {
                await PointService.Add(new PointEntry
                {
                    PlayerId = loser.Id,
                    Points = -SelectedPoint,
                    Date = date
                });
            }
        }

        await LoadPoints();
        IsModalOpen = false;
    }

    // ------------------------------------------------------------
    // UI helpers: farver/intensitet i skemaet
    // ------------------------------------------------------------

    private string GetCellClass(int? value, int columnIndex, string rowLabel)
    {
        if (!value.HasValue)
            return "cell-empty";

        var color = columnIndex switch
        {
            13 => "cell-yellow",  // "0"
            > 13 => "cell-green", // højre
            _ => "cell-red"       // venstre
        };

        var intensity = GetIntensityFromLabel(rowLabel);
        return $"{color} {intensity}";
    }

    private string GetHeaderClass(int columnIndex)
    {
        if (columnIndex == 13) return "cell-yellow";
        if (columnIndex > 13) return "cell-green";
        return "cell-red";
    }

    private string GetIntensityFromLabel(string label)
    {
        if (label.Contains("Alm.")) return "low";
        if (label.Contains("Vip")) return "medium";
        if (label.Contains("Gode")) return "high";
        if (label.Contains("Halve")) return "very-high";
        return "";
    }

    // ------------------------------------------------------------
    // “Tilføj bøder”: konverter point (minus) + stjerner → fines, og reset
    // ------------------------------------------------------------

    private async Task ResetPointsAndCreateFines()
    {
        // 1) Hent seneste totals (sikkerhed)
        await LoadPoints();
        var now = DateTime.UtcNow;

        // 2) Opret bøder for dem med minus.
        // Split i bidder af max 500 pga Fine.Amount [Range(1..500)]
        foreach (var kv in PlayerTotals)
        {
            var userId = kv.Key;
            var total = kv.Value;

            if (total < 0)
            {
                var amountRemaining = Math.Abs(total);

                while (amountRemaining > 0)
                {
                    var chunk = Math.Min(500, amountRemaining);

                    await FineService.Add(new Fine
                    {
                        UserId = userId,
                        Amount = chunk,        // kun positive beløb i bøder
                        Comment = "Whist",
                        Date = now,
                        IsPaid = false
                    });

                    amountRemaining -= chunk;
                }
            }
        }

        // 2b) Opret stjerne-bøder baseret på SessionStars (lægger sig oven i eksisterende)
        foreach (var kv in SessionStars)
        {
            var userId = kv.Key;
            var stars = kv.Value;

            if (stars <= 0) continue;

            for (var i = 0; i < stars; i++)
            {
                await FineService.Add(new Fine
                {
                    UserId = userId,
                    Amount = 5,
                    Comment = "Stjerne",
                    Date = now,
                    IsPaid = false
                });
            }
        }

        // 3) Slet ALLE points i databasen
        await PointService.DeleteAll(); // kalder api/point/all i din PointService

        // 4) Reset session-stjerner (localStorage)
        await ResetSessionStarsAsync();

        foreach (var id in SessionStars.Keys.ToList())
            SessionStars[id] = 0;

        // 5) Opdatér UI (nul totals)
        await LoadPoints();
    }

    // ------------------------------------------------------------
    // Session stars (localStorage)
    // ------------------------------------------------------------

    private async Task AddSessionStar(int userId)
    {
        if (_currentUser is null)
            return;

        SessionStars[userId] = SessionStars.TryGetValue(userId, out var s) ? s + 1 : 1;
        await SaveSessionStarsAsync();
    }

    private int GetSessionStars(int userId)
        => SessionStars.TryGetValue(userId, out var s) ? s : 0;

    private async Task SaveSessionStarsAsync()
    {
        var json = System.Text.Json.JsonSerializer.Serialize(SessionStars);
        await JS.InvokeVoidAsync("localStorage.setItem", SessionStarsStorageKey, json);
    }

    private async Task LoadSessionStarsAsync()
    {
        var json = await JS.InvokeAsync<string>("localStorage.getItem", SessionStarsStorageKey);

        SessionStars = string.IsNullOrWhiteSpace(json)
            ? new Dictionary<int, int>()
            : System.Text.Json.JsonSerializer.Deserialize<Dictionary<int, int>>(json) ?? new();
    }

    private async Task ResetSessionStarsAsync()
    {
        // Behold keys (spillere), men sæt alt til 0
        foreach (var id in SessionStars.Keys.ToList())
            SessionStars[id] = 0;

        await SaveSessionStarsAsync();
    }
}

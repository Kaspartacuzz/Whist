@page "/b√∏der"
@using Core
@using WebApp.Service
@using WebApp.Service.AuthServices
@using WebApp.Service.FineServices
@using WebApp.Components

@inject IFineService FineService
@inject IUserService UserService
@inject IAuthService AuthService
@inject IJSRuntime JSRuntime

<!-- =========================
     TOP: Titel + Tilf√∏j b√∏de
     ========================= -->
<div class="top-bar">
    <h2>B√∏der</h2>
    <button class="btn-add" @onclick="OpenAddFineModal">+ Tilf√∏j b√∏de</button>
</div>

<!-- =========================
     BRUGERKORT (overblik pr. person)
     ========================= -->
<div class="user-grid">
    @foreach (var user in Users)
    {
        // Vi bruger "AllFinesForSummary" til alt overblik (kort + totals + stjerner)
        var userFines = AllFinesForSummary.Where(f => f.UserId == user.Id).ToList();
        var total = userFines.Sum(f => f.Amount);
        var paid = userFines.Where(f => f.IsPaid).Sum(f => f.Amount);
        var unpaid = total - paid;

        <div class="user-card">
            <!-- Stjerne-knap (opretter en "stjerne-b√∏de") -->
            <div class="star-button-wrapper">
                <button class="star-button" @onclick="() => AddStarFine(user.Id)">
                    ‚≠ê
                    @if (GetStarCount(user.Id) > 0)
                    {
                        <span class="star-count">@GetStarCount(user.Id)</span>
                    }
                </button>
            </div>

            <div class="user-header">@user.NickName</div>

            <div class="user-info">
                <span>I alt:</span><span class="amount">@total kr</span>
                <span>Betalt:</span><span class="amount">@paid kr</span>
                <span>Mangler:</span>
                <span class="amount @(unpaid > 0 ? "text-red" : "text-green")">@unpaid kr</span>
            </div>

            <!-- "Betal nu" vises kun for den bruger der er logget ind + kun hvis der mangler betaling -->
            @if (CurrentUser?.Id == user.Id && unpaid > 0)
            {
                <button class="pay-button" @onclick="PayNow">Betal nu</button>
            }
        </div>
    }
</div>

<!-- =========================
     HORISONTAL OVERSIGT (Totals + Stjerner)
     ========================= -->
<div class="overview-box overview-strip">

    <!-- KPI'er (venstre) -->
    <div class="strip-kpis">
        <div class="kpi">
            <div class="kpi-label">B√∏der i alt</div>
            <div class="kpi-value">@TotalAmount kr</div>
        </div>

        <div class="kpi">
            <div class="kpi-label">Mangler at blive betalt</div>
            <div class="kpi-value text-red">@TotalUnpaid kr</div>
        </div>
    </div>

    <div class="strip-divider"></div>

    <!-- Stjerner i alt (h√∏jre) -->
    <div class="strip-stars">
        <div class="overview-title strip-title">Stjerner i alt</div>

        @foreach (var user in Users)
        {
            var count = GetStarTotalCount(user.Id);

            // Procent ift. den der har flest stjerner (s√• baren skalerer korrekt)
            var pct = MaxStarTotal == 0 ? 0 : (int)Math.Round(count * 100.0 / MaxStarTotal);

            <div class="star-row">
                <div class="star-name">@user.NickName</div>
                <div class="star-track">
                    <div class="star-fill" style="width:@($"{pct}%")"></div>
                </div>
                <div class="star-value">@count</div>
            </div>
        }
    </div>
</div>

<!-- =========================
     FILTER-BOKS
     ========================= -->
<div class="filter-box-wrapper">
    <div class="filter-row">
        <div class="filter-item search">
            <span class="icon-search">üîç</span>
            <input placeholder="S√∏g i b√∏der..." @bind-value="searchTerm" @bind-value:event="oninput" @bind-value:after="OnFiltersChanged" />
        </div>

        <div class="filter-item date">
            <span class="icon-calendar">üìÖ</span>
            <input type="date" @bind-value="filterFromDate" @bind-value:event="oninput" @bind-value:after="OnFiltersChanged" />
        </div>

        <div class="filter-item date">
            <span class="icon-calendar">üìÖ</span>
            <input type="date" @bind-value="filterToDate" @bind-value:event="oninput" @bind-value:after="OnFiltersChanged" />
        </div>
    </div>

    <div class="filter-row">
        <div class="filter-item amount">
            <span class="icon-money">üí∞</span>
            <input type="number" placeholder="Min bel√∏b" @bind-value="filterMinAmount" @bind-value:event="oninput"  @bind-value:after="OnFiltersChanged"/>
        </div>

        <div class="filter-item amount">
            <span class="icon-money">üí∞</span>
            <input type="number" placeholder="Max bel√∏b" @bind-value="filterMaxAmount" @bind-value:event="oninput" @bind-value:after="OnFiltersChanged" />
        </div>

        <div class="filter-item dropdown">
            <label>Status:</label>
            <select class="filter-select" @bind="filterPaidStatus" @bind:after="OnFiltersChanged">
                <option value="">Alle</option>
                <option value="true">‚úÖ Betalt</option>
                <option value="false">‚ùå Ikke betalt</option>
            </select>
        </div>
    </div>
</div>

<!-- =========================
     TABEL (viser page‚Äôen af b√∏der)
     ========================= -->
<div class="fine-table">
    <table>
        <thead>
        <tr>
            <th>Dato</th>
            <th>Navn</th>
            <th>Bel√∏b</th>
            <th>Betalt</th>
            <th>Kommentar</th>
            <th></th>
        </tr>
        </thead>

        <tbody>
        @foreach (var fine in FilteredFines)
        {
            var user = Users.FirstOrDefault(u => u.Id == fine.UserId);

            <tr>
                <td>@fine.Date.ToShortDateString()</td>
                <td>@user?.NickName</td>
                <td>@fine.Amount kr</td>
                <td>@(fine.IsPaid ? "‚úÖ" : "‚ùå")</td>
                <td>@fine.Comment</td>
                <td>
                    @if (fine.UserId != CurrentUser?.Id)
                    {
                        <button class="icon-button blue" @onclick="() => EditFine(fine)">‚úèÔ∏è</button>
                        <button class="icon-button red" @onclick="() => ConfirmDelete(fine)">üóëÔ∏è</button>
                    }
                </td>
            </tr>
        }
        </tbody>
    </table>

    <!-- Slet-confirm modal -->
    <ConfirmDeleteComponent @ref="confirmComponent"
                            OnConfirm="DeleteConfirmed"
                            OnCancel="CancelDelete"
                            Message="Er du sikker p√• at du vil slette denne b√∏de?" />
</div>

<!-- Pagination (kun hvis der er flere sider) -->
@if (TotalPages > 1)
{
    <PaginationComponent CurrentPage="CurrentPage"
                         TotalPages="TotalPages"
                         OnPageChanged="LoadPage" />
}

<!-- Add/Edit modal -->
<AddFineComponent @ref="addFineComponent" OnFineAdded="ReloadFines" />

@code {
    // -----------------------------
    // State
    // -----------------------------
    private List<Fine> Fines = new();                 // Det der vises i tabellen (current page)
    private List<Fine> AllFinesForSummary = new();    // Bruges til kort/oversigter (alle b√∏der)
    private List<User> Users = new();                 // Alle brugere
    private User? CurrentUser;                        // Logget ind bruger

    private string searchTerm = "";

    // Component refs (modaler)
    private AddFineComponent? addFineComponent;
    private ConfirmDeleteComponent? confirmComponent;

    private Fine? FineToDelete = null;

    // -----------------------------
    // Paging
    // -----------------------------
    private int CurrentPage = 1;
    private int TotalCount = 0;
    private const int PageSize = 10;
    private int TotalPages => (int)Math.Ceiling((double)TotalCount / PageSize);

    // -----------------------------
    // Filtre
    // -----------------------------
    private DateTime? filterFromDate = null;
    private DateTime? filterToDate = null;
    private decimal? filterMinAmount = null;
    private decimal? filterMaxAmount = null;
    private string? filterPaidStatus = null;
    private async Task OnFiltersChanged() => await LoadPage(1);

    // -----------------------------
    // Beregnede totals (til KPI'er)
    // -----------------------------
    private decimal TotalAmount => AllFinesForSummary.Sum(f => f.Amount);
    private decimal TotalUnpaid => AllFinesForSummary.Where(f => !f.IsPaid).Sum(f => f.Amount);

    // Hvor meget den aktuelle bruger mangler at betale
    private decimal UserUnpaid =>
        CurrentUser is null
            ? 0
            : AllFinesForSummary.Where(f => f.UserId == CurrentUser.Id && !f.IsPaid).Sum(f => f.Amount);

    // -----------------------------
    // Stjerner
    // -----------------------------

    // Stjerner i alt gennem tiden (b√•de betalte og ubetalte)
    private int GetStarTotalCount(int userId)
        => AllFinesForSummary.Count(f => f.UserId == userId && f.Comment == "Stjerne");

    // Max stjerner (bruges til at skalere baren korrekt)
    private int MaxStarTotal
        => Users.Count == 0 ? 0 : Users.Max(u => GetStarTotalCount(u.Id));

    // Stjerner der IKKE er betalt (badge p√• bruger-kortet)
    private int GetStarCount(int userId)
        => AllFinesForSummary.Count(f => f.UserId == userId && f.Comment == "Stjerne" && !f.IsPaid);

    // -----------------------------
    // Filtreret b√∏der ud fra dato
    // -----------------------------
    private IEnumerable<Fine> FilteredFines => Fines.OrderByDescending(f => f.Date);


    // -----------------------------
    // Lifecycle
    // -----------------------------
    protected override async Task OnInitializedAsync()
    {
        Users = (await UserService.GetAll()).ToList();
        CurrentUser = await AuthService.GetCurrentUser();

        // 1) Indl√¶s alle b√∏der til overblik
        await LoadSummary();

        // 2) Indl√¶s f√∏rste side til tabel
        await LoadPage(1);
    }

    // -----------------------------
    // UI actions
    // -----------------------------

    // √Öbner modal til at oprette en b√∏de
    private async Task OpenAddFineModal()
    {
        if (addFineComponent != null)
            await addFineComponent.Show();
    }

    // Betal nu:
    // 1) √•bner MobilePay box
    // 2) markerer alle ubetalte b√∏der for CurrentUser som betalt i DB
    // 3) reloader UI (summary + tabel)
    private async Task PayNow()
    {
        if (CurrentUser is null)
            return;

        if (UserUnpaid <= 0)
        {
            await JSRuntime.InvokeVoidAsync("alert", "Du har ingen ubetalte b√∏der ‚Äì st√¶rkt g√•et üí™");
            return;
        }

        // √Öbn MobilePay box i ny fane (din nuv√¶rende l√∏sning)
        var mobilePayUrl = "https://qr.mobilepay.dk/box/fe1b90f5-2c86-49be-af9f-8562d21a5b3a/pay-in";
        await JSRuntime.InvokeVoidAsync("open", mobilePayUrl, "_blank");

        // Marker ALLE ubetalte b√∏der for brugeren som betalt
        var unpaidFines = AllFinesForSummary
            .Where(f => f.UserId == CurrentUser.Id && !f.IsPaid)
            .ToList();

        foreach (var fine in unpaidFines)
        {
            fine.IsPaid = true;
            await FineService.Update(fine);
        }

        await ReloadFines();
    }

    // -----------------------------
    // CRUD: Delete / Edit
    // -----------------------------
    private void ConfirmDelete(Fine fine)
    {
        FineToDelete = fine;
        confirmComponent?.Show();
    }

    private async Task DeleteConfirmed()
    {
        if (FineToDelete is not null)
        {
            await FineService.Delete(FineToDelete.UserId, FineToDelete.Id);
            FineToDelete = null;
            await ReloadFines();
        }
    }

    private void CancelDelete()
    {
        FineToDelete = null;
    }

    // √Öbner AddFine modal i edit-mode (AddFineComponent h√•ndterer selv "edit vs add")
    private async Task EditFine(Fine fine)
    {
        FineToDelete = null; // vigtig: ryd state
        if (addFineComponent is not null)
            await addFineComponent.Show(fine);
    }

    // -----------------------------
    // Stjerne-b√∏de
    // -----------------------------
    private async Task AddStarFine(int userId)
    {
        var fine = new Fine
        {
            UserId = userId,
            Amount = 5,
            Comment = "Stjerne",
            Date = DateTime.Now,
            IsPaid = false
        };

        await FineService.Add(fine);
        await ReloadFines();
    }

    // -----------------------------
    // Paging + reload helpers
    // -----------------------------
    private async Task LoadPage(int page)
    {
        CurrentPage = page < 1 ? 1 : page;

        // Bem√¶rk: din GetPaged endpoint server-side pager data (godt!)
        var result = await FineService.GetPaged(
            CurrentPage,
            PageSize,
            userId: null, // behold null hvis du viser alle;
            searchTerm: searchTerm,
            fromDate: filterFromDate,
            toDate: filterToDate,
            minAmount: filterMinAmount,
            maxAmount: filterMaxAmount,
            isPaid: ParsePaidStatus());

        Fines = result.Items.ToList();
        TotalCount = result.TotalCount;

        StateHasChanged();
    }

    // Reloader b√•de summary (kort/oversigt) og tabel (current page)
    private async Task ReloadFines()
    {
        await LoadSummary();

        // Hvis sidste element p√• en side bliver slettet, hop √©n side tilbage
        if (Fines.Count == 1 && CurrentPage > 1)
            await LoadPage(CurrentPage - 1);
        else
            await LoadPage(CurrentPage);

        StateHasChanged();
    }

    // Henter ALLE b√∏der (bruges kun til kort/oversigt)
    private async Task LoadSummary()
    {
        AllFinesForSummary = (await FineService.GetAll()).ToList();
    }
    
    // Filtrere status p√• om en b√∏de er betalt
    private bool? ParsePaidStatus()
    {
        if (string.IsNullOrWhiteSpace(filterPaidStatus))
            return null;
        
        return filterPaidStatus == "true";
    }
}

@page "/b√∏der"
@using Core
@using WebApp.Service
@using WebApp.Service.AuthServices
@using WebApp.Service.FineServices
@using WebApp.Components

@inject IFineService FineService
@inject IUserService UserService
@inject IAuthService AuthService
@inject IJSRuntime JSRuntime

<!-- Tilf√∏j knap -->
<div class="top-bar">
    <h2>B√∏der</h2>
    <button class="btn-add" @onclick="OpenAddFineModal">+ Tilf√∏j b√∏de</button>
</div>

<!-- Brugeroversigt -->
<div class="user-grid">
    @foreach (var user in Users)
    {
        var userFines = Fines.Where(f => f.UserId == user.Id).ToList();
        var total = userFines.Sum(f => f.Amount);
        var paid = userFines.Where(f => f.IsPaid).Sum(f => f.Amount);
        var unpaid = total - paid;

        <div class="user-card">
            <div class="user-header">@user.NickName</div>
            <div class="user-info">
                <span>I alt:</span><span class="amount">@total kr</span>
                <span>Betalt:</span><span class="amount">@paid kr</span>
                <span>Mangler:</span>
                <span class="amount @(unpaid > 0 ? "text-red" : "text-green")">@unpaid kr</span>
            </div>

            @if (CurrentUser?.Id == user.Id && unpaid > 0)
            {
                <button class="pay-button" @onclick="PayNow">Betal nu</button>
            }
        </div>
    }
</div>

<!-- Samlet oversigt -->
<div class="overview-box">
    <div class="overview-title">Oversigt</div>
    <p>üëâ <strong>B√∏der i alt:</strong> @TotalAmount kr</p>
    <p>üìä <strong>Mangler at blive betalt:</strong> @TotalUnpaid kr</p>
</div>

<!-- Filtrering -->
<div class="filter-box">
    <div class="filter-item search">
        <span class="icon-search">üîç</span>
        <input placeholder="S√∏g i b√∏der..." @bind-value="searchTerm" @bind-value:event="oninput" />
    </div>

    <div class="filter-item date">
        <span class="icon-calendar">üìÖ</span>
        <input type="date" @bind-value="filterFromDate" @bind-value:event="oninput" />
    </div>

    <div class="filter-item date">
        <span class="icon-calendar">üìÖ</span>
        <input type="date" @bind-value="filterToDate" @bind-value:event="oninput" />
    </div>

    <div class="filter-item amount">
        <span class="icon-money">üí∞</span>
        <input type="number" placeholder="Min bel√∏b" @bind-value="filterMinAmount" @bind-value:event="oninput" />
    </div>

    <div class="filter-item amount">
        <span class="icon-money">üí∞</span>
        <input type="number" placeholder="Max bel√∏b" @bind-value="filterMaxAmount" @bind-value:event="oninput" />
    </div>
</div>

<!-- Tabel -->
<div class="fine-table">
    <table>
        <thead>
            <tr>
                <th>Dato</th>
                <th>Navn</th>
                <th>Bel√∏b</th>
                <th>Kommentar</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var fine in FilteredFines)
            {
                var user = Users.FirstOrDefault(u => u.Id == fine.UserId);
                <tr>
                    <td>@fine.Date.ToShortDateString()</td>
                    <td>@user?.NickName</td>
                    <td>@fine.Amount kr</td>
                    <td>@fine.Comment</td>
                    <td>
                        @if (fine.UserId != CurrentUser?.Id)
                        {
                            <button class="icon-button blue" @onclick="() => EditFine(fine)">‚úèÔ∏è</button>
                            <button class="icon-button red" @onclick="() => ConfirmDelete(fine)">üóëÔ∏è</button>
                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>

    <ConfirmDeleteComponent @ref="confirmComponent"
                            OnConfirm="DeleteConfirmed"
                            OnCancel="CancelDelete"
                            Message="Er du sikker p√• at du vil slette denne b√∏de?" />
</div>

<AddFineComponent @ref="addFineComponent" OnFineAdded="ReloadFines" />

@code {
    private List<Fine> Fines = new();
    private List<User> Users = new();
    private string searchTerm = "";
    private User? CurrentUser;
    private AddFineComponent? addFineComponent;
    private ConfirmDeleteComponent? confirmComponent;
    private Fine? FineToDelete = null;
    
    //Filtreringer
    private DateTime? filterFromDate = null;
    private DateTime? filterToDate = null;
    private decimal? filterMinAmount = null;
    private decimal? filterMaxAmount = null;
    
    private decimal TotalAmount => Fines.Sum(f => f.Amount);
    private decimal TotalUnpaid => Fines.Where(f => !f.IsPaid).Sum(f => f.Amount);

    private IEnumerable<Fine> FilteredFines => Fines
        .Where(f =>
            // S√∏gefelt (navn eller kommentar)
            (string.IsNullOrWhiteSpace(searchTerm) ||
             Users.FirstOrDefault(u => u.Id == f.UserId)?.NickName?.ToLower().Contains(searchTerm.ToLower()) == true ||
             f.Comment.ToLower().Contains(searchTerm.ToLower()))

            // Dato filter
            && (!filterFromDate.HasValue || f.Date.Date >= filterFromDate.Value.Date)
            && (!filterToDate.HasValue || f.Date.Date <= filterToDate.Value.Date)

            // Bel√∏b filter
            && (!filterMinAmount.HasValue || f.Amount >= filterMinAmount.Value)
            && (!filterMaxAmount.HasValue || f.Amount <= filterMaxAmount.Value)
        )
        .OrderByDescending(f => f.Date);

    
    private decimal UserUnpaid =>
        CurrentUser is null
            ? 0
            : Fines.Where(f => f.UserId == CurrentUser.Id && !f.IsPaid).Sum(f => f.Amount);

    protected override async Task OnInitializedAsync()
    {
        Fines = (await FineService.GetAll()).ToList();
        Users = (await UserService.GetAll()).ToList();
        CurrentUser = await AuthService.GetCurrentUser();
    }
    
    private async Task OpenAddFineModal()
    {
        if (addFineComponent != null)
            await addFineComponent.Show();
    }

    private async Task ReloadFines()
    {
        Fines = (await FineService.GetAll()).ToList();
        StateHasChanged();
    }
    
    private async Task PayNow()
    {
        if (CurrentUser is null)
            return;

        if (UserUnpaid <= 0)
        {
            await JSRuntime.InvokeVoidAsync("alert", "Du har ingen ubetalte b√∏der ‚Äì st√¶rkt g√•et üí™");
            return;
        }

        // URL til mobilepay boks
        var mobilePayUrl = $"https://qr.mobilepay.dk/box/fe1b90f5-2c86-49be-af9f-8562d21a5b3a/pay-in";

        await JSRuntime.InvokeVoidAsync("open", mobilePayUrl, "_blank");

        // Marker som betalt
        foreach (var fine in Fines.Where(f => f.UserId == CurrentUser.Id && !f.IsPaid))
        {
            fine.IsPaid = true;
            await FineService.Update(fine);
        }

        await ReloadFines();
    }
    
    private void ConfirmDelete(Fine fine)
    {
        FineToDelete = fine;
        confirmComponent?.Show();
    }

    private async Task DeleteConfirmed()
    {
        if (FineToDelete is not null)
        {
            await FineService.Delete(FineToDelete.Id);
            FineToDelete = null;
            await ReloadFines();
        }
    }


    private void CancelDelete()
    {
        FineToDelete = null;
    }
    
    private async Task EditFine(Fine fine)
    {
        FineToDelete = null; // üßπ vigtig!
    
        if (addFineComponent is not null)
            await addFineComponent.Show(fine);
    }
}

